<!DOCTYPE html>
<html>
  <head>
    <title>JUnit Live Viewer</title>
    <style>
        td {
            padding: 2px;
        }
    </style>
  </head>
  <body>
    <h1>JUnit Test Results</h1>
    <pre id="results-body"></pre>
    <script>
      const rowMap = new Map();

      const getTestId = (suite, testCase) =>
        `${suite.name || "unknown"}::${testCase.name}`;

      function updateTestRow(suite, testCase, path) {
        const testId = getTestId(suite, testCase);
        let row = rowMap.get(testId);

        if (!row) {
          row = document.createElement("tr");

          const nameCell = document.createElement("td");
          const statusCell = document.createElement("td");
          const timeCell = document.createElement("td");
          const suiteCell = document.createElement("td");

          row.append(nameCell, statusCell, timeCell, suiteCell);
          row.dataset.testId = testId;

          rowMap.set(testId, row);
          document.getElementById("results-body").appendChild(row);
        }

        const [nameCell, statusCell, timeCell, suiteCell] = row.children;

        nameCell.textContent = testCase.original_name || testCase.name;
        const status = testCase.status === "Success" ? testCase.status : Object.keys(testCase.status)[0];

        statusCell.textContent = status;
        statusCell.style.color =
          testCase.status === "Success" ? "green" : "red";
        timeCell.textContent = testCase.time;
        suiteCell.textContent = suite.name || path;
      }

      const ws = new WebSocket("ws://localhost:3000/ws");
      ws.onmessage = (event) => {
        const [path, suite] = JSON.parse(event.data);

        for (const s of suite.suites || []) {
          for (const c of s.cases || []) {
            updateTestRow(s, c, path);
          }
        }
      };

      fetch("http://localhost:3000/refresh", { method: "POST" });
    </script>
  </body>
</html>
